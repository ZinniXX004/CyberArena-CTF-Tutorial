import hashlib
import os
import requests
import sys

# CONFIGURATION
# Path relative to solutions folder
CHALLENGE_DIR = os.path.join(os.path.dirname(__file__), "../challenges/03-crypto-crack")
ENCRYPTED_FILE = os.path.join(CHALLENGE_DIR, "flag.enc")
GAME_SERVER = "http://localhost:3000/submit"
TEAM_NAME = "RedTeam"

# The file starts with this header (Known Plaintext Attack)
KNOWN_HEADER = b"HEADER:" 

def solve_xor():
    print("[*] Phase 1: Cracking XOR Encryption...")
    
    if not os.path.exists(ENCRYPTED_FILE):
        print(f"[!] Error: {ENCRYPTED_FILE} not found. Run build script first.")
        return None

    with open(ENCRYPTED_FILE, "rb") as f:
        ciphertext = f.read()

    # Logic: Ciphertext[0] ^ Key[0] = Plaintext[0], therefore: Ciphertext[0] ^ Plaintext[0] = Key[0]
    
    derived_key = bytearray()
    for i in range(len(KNOWN_HEADER)):
        derived_key.append(ciphertext[i] ^ KNOWN_HEADER[i])
    
    # In this specific challenge, the key repeats, the key length seems to be 4 bytes based on the derivation (R, U, S, T)
    key = bytes(derived_key[:4]) 
    print(f"[+] Recovered Key: {key}")

    # Now decrypt the whole file
    decrypted = bytearray()
    for i in range(len(ciphertext)):
        decrypted.append(ciphertext[i] ^ key[i % len(key)])
    
    print(f"[+] Decrypted Content: {decrypted}")
    
    # Extract flag from text
    try:
        text = decrypted.decode('utf-8', errors='ignore')
        if "CTF{" in text:
            start = text.find("CTF{")
            end = text.find("}", start) + 1
            return text[start:end]
    except:
        pass
    
    return None

def solve_sha256():
    print("\n[*] Phase 2: Brute-forcing SHA-256 PIN...")
    target_hash = "1b16f3933c066324a30ddb947c6b453e9a72df525164f849c7161b4028564c48"
    
    # We suspect it's a 4-digit PIN (0000-9999)
    for i in range(10000):
        # Format as 4 digits (e.g., 0005, 0123)
        pin = f"{i:04d}"
        
        # Calculate Hash
        pin_hash = hashlib.sha256(pin.encode()).hexdigest()
        
        if pin_hash == target_hash:
            print(f"[+] CRACKED! The PIN is: {pin}")
            return pin
            
    print("[-] Failed to crack PIN.")
    return None

def submit_to_server(flag):
    if not flag: return
    print(f"\n[*] Submitting to Game Server: {GAME_SERVER}")
    try:
        data = {"team_name": TEAM_NAME, "flag": flag}
        r = requests.post(GAME_SERVER, json=data)
        print(f"[>] Server Response: {r.status_code} | {r.text}")
    except Exception as e:
        print(f"[!] Server connection failed: {e}")

if __name__ == "__main__":
    # 1. Crack the File
    flag = solve_xor()
    
    # 2. Crack the Hash (Just for demonstration/points)
    _ = solve_sha256()
    
    # 3. Submit
    if flag:
        submit_to_server(flag)
